<!doctype html>
<html lang="en">
<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">

    <title>Snake Program</title>
</head>
<body>
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>

    <canvas id="myCanvas" width="400" height="400"> </canvas>
    <br />
    <p>Game will start once u press a valid key to move the snake.</p>
    <p>Press any left/right/up/down arrows to move the green box to the goal (red square).</p>
    <p>Press space bar to pause the game and resume the game!</p>
    <p>Don't run into yourself or the wall!</p>
    <p id="Score">Score: 0<br />
    <p id="Status">Game Not Started<br />
</body>
<script>
    /**
    * Some global variables.
    */
    var DirectionEnum = Object.freeze({ "LEFT": 0, "RIGHT": 1, "UP": 2, "DOWN": 3, "NONE": 4 })
    var directionKeys = [[-10, 0], [10, 0], [0, -10], [0, 10], [0, 0]];
    var con_dir = null;
    var prev_dir = null;
    var child = null;

    //Head
    positionX = positionY = 10;

    //Tail without the Head
    trail = [];   //The trail list is used to track the trailing green boxes and their positions
    tail = 5;   // Length of the tail

    //Red Box
    ax = ay = 190;

    //Boolean Variables for status of the game
    paused = false;
    gameOver = false;
    gameStarted = false;


    window.onload = function () {
        canv = document.getElementById("myCanvas");
        ctx = canv.getContext("2d");

        //Initialize the green snake, red box and black canvas.
        for (var i = 0; i < canv.height; i += 10) {
            for (var j = 0; j < canv.width; j += 10) {
                if (i == positionY && j == positionX) {
                    ctx.fillStyle = "green";
                    ctx.fillRect(j, i, 10, 10);
                } else if (i == ay && j == ax) {
                    ctx.fillStyle = "red";
                    ctx.fillRect(j, i, 10, 10);
                } else {
                    ctx.fillStyle = "black";
                    ctx.fillRect(j, i, 10, 10);
                }
            }
        }
        //Once the player pressed a button, the game is started
        document.addEventListener("keydown", keyPushed);
        statusElement = document.getElementById("Status"); //Changing the status of the game
        scoreElement = document.getElementById("Score"); //Changing the score of the game
        statusElement.style.fontSize = 40;
        scoreElement.style.fontSize = 40;
        score = 0;
        child = setInterval(playSnakeGame, 200); // This keeps running the playSnakeGame function every 200 msec.
    }


    function playSnakeGame() {
        //Move the snake and target
        if (con_dir != null) {
            checkAndMove(con_dir);
        }
        //End game if out of bounds
        checkBounds();
        //End game if crosses it self


    }
    function targetmet() {
        score += 1;
        scoreElement.innerHTML = "Score: " + score.toString();
        console.log("goal!")
        for (var a = 0; a < tail; a++) {
            if (trail.length == 0) {
                var last = [positionX, positionY];
            } else {
                var last = trail[trail.length - 1];
            }
            var pos_ = [];

            //Generate all possible new tail locations
            for (var x = 0; x < 4; x++) {
                var new_x = last[0] + directionKeys[x][0];
                var new_y = last[1] + directionKeys[x][1];
                var list = [];
                list.push(new_x);
                list.push(new_y);
                pos_.push(list);
            }

            //Add a valid tail to trail
            for (var x = 0; x < 4; x++) {
                p = pos_[x];
                var add = true;
                //Check if in the trail list
                for (var y = 0; y < trail.length; y++) {
                    if (p[0] == trail[y][0] && p[1] == trail[y][1]) {
                        add = false;
                        break;
                    }
                }
                //If not in trail list, check for out of border
                if (add) {
                    if ((p[0] >= 0 && p[0] <= 390) && (p[1] >= 0 && p[1] <= 390)) {
                        //Append to trail if satisfied, and break the loop
                        trail.push(p);
                        break;
                    }
                }
            }

        }

        //Change the target position
        var valid = false;
        while (!valid) {
            console.log("changed!");
            ax = Math.floor(Math.random() * 39) * 10;
            ay = Math.floor(Math.random() * 39) * 10;
            //check if valid
            if (ax != positionX && ay != positionY) {
                valid = true;
                for (var i = 0; i < trail.length; i++) {
                    if (ax == trail[i][0] && ay == trail[i][1]) {
                        //loop again!
                        valid = false;
                        break;
                    }
                }
            }
        }

    }

    function keyPushed(evt) {

        switch (evt.keyCode) { //Different int values for keycodes correspond to different numbers - these have been mapped out in a switch case for ease of use.
            case 37:
                console.log("LEFT");
                if (con_dir != DirectionEnum["NONE"]) {
                    if (trail.length > 0 && con_dir != DirectionEnum["RIGHT"]) {
                        con_dir = DirectionEnum["LEFT"];
                        checkAndMove(con_dir);
                    } else if (trail.length == 0) {
                        con_dir = DirectionEnum["LEFT"];
                        checkAndMove(con_dir);
                    }
                }
                break;

            case 40:
                console.log("DOWN");
                if (con_dir != DirectionEnum["NONE"]) {
                    if (trail.length > 0 && con_dir != DirectionEnum["UP"]) {
                        con_dir = DirectionEnum["DOWN"];
                        checkAndMove(con_dir);
                    } else if (trail.length == 0) {
                        con_dir = DirectionEnum["DOWN"];
                        checkAndMove(con_dir);
                    }
                }
                break;

            case 39:
                console.log("RIGHT");
                if (con_dir != DirectionEnum["NONE"]) {
                    if (trail.length > 0 && con_dir != DirectionEnum["LEFT"]) {
                        con_dir = DirectionEnum["RIGHT"];
                        checkAndMove(con_dir);
                    } else if (trail.length == 0) {
                        con_dir = DirectionEnum["RIGHT"];
                        checkAndMove(con_dir);
                    }
                }
                break;

            case 38:
                console.log("UP");
                if (con_dir != DirectionEnum["NONE"]) {
                    if (trail.length > 0 && con_dir != DirectionEnum["DOWN"]) {
                        con_dir = DirectionEnum["UP"];
                        checkAndMove(con_dir);
                    } else if (trail.length == 0) {
                        con_dir = DirectionEnum["UP"];
                        checkAndMove(con_dir);
                    }
                }
                break;

            case 32:
                console.log("SPACE");
                if (con_dir != DirectionEnum["NONE"]) {
                    prev_dir = con_dir;
                    con_dir = DirectionEnum["NONE"];
                    checkAndMove(con_dir);
                } else {
                    con_dir = prev_dir;
                    checkAndMove(con_dir);
                }
                break;
        }
    }

    function checkBounds() {
        if ((positionX < 0 || positionX > 390) || (positionY < 0 || positionY > 390)) {
            statusElement.innerHTML = "Game Over";
            console.log("End Game");
            clearTimeout(child);
            document.removeEventListener("keydown", keyPushed);
        }
    }
    function checkCross() {
        for (var i = 0; i < trail.length; i++) {
            if (positionX == trail[i][0] && positionY == trail[i][1]) {
                statusElement.innerHTML = "Game Over";
                console.log("End Game");
                clearTimeout(child);
                document.removeEventListener("keydown", keyPushed);
            }
        }
    }

    function checkAndMove(value) {
        // Given the direction in numbers, use direction keys to change the snake
        var buf_pos_x = positionX;
        var buf_pos_y = positionY;
        var dir = directionKeys[value];
        positionX += dir[0];
        positionY += dir[1];
        if (value != 4) {
            //Move the Tail with the Head
            statusElement.innerHTML = "Game In Progress";
            for (var i = 0; i < trail.length; i++) {
                var next_x = trail[i][0];
                var next_y = trail[i][1];
                trail[i][0] = buf_pos_x;
                trail[i][1] = buf_pos_y;
                buf_pos_x = next_x;
                buf_pos_y = next_y;
            }
        } else {
            statusElement.innerHTML = "Game Paused";
        }

        //check if target is met
        if (positionX == ax && positionY == ay) {
            targetmet();
        }
        checkCross();
        checkBounds();

        for (var i = 0; i < canv.height; i += 10) {
            for (var j = 0; j < canv.width; j += 10) {
                //check if in the Tail
                var tail = false;
                for (var s = 0; s < trail.length; s++) {
                    if (i == trail[s][1] && j == trail[s][0]) {
                        ctx.fillStyle = "green";
                        ctx.fillRect(j, i, 10, 10);
                        tail = true;
                        break;
                    }
                }
                if (i == positionY && j == positionX) {
                    ctx.fillStyle = "green";
                    ctx.fillRect(j, i, 10, 10);
                } else if (i == ay && j == ax) {
                    ctx.fillStyle = "red";
                    ctx.fillRect(j, i, 10, 10);
                } else if (!tail) {
                    ctx.fillStyle = "black";
                    ctx.fillRect(j, i, 10, 10);
                }
            }
        }
    }

</script>
</html>
